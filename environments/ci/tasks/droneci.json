[
  { "cpu": 256,
    "image": "governmentpaas/awscli:latest",
    "memoryReservation": 20,
    "name": "kms-secrets",
    "environment": [
      { "name": "DRONE_SECRET",
        "value": "AQECAHjxFVv28s35RRShRB2bYo11qtmAuBRaqhGRrhmkdMTRYgAAAGgwZgYJKoZIhvcNAQcGoFkwVwIBADBSBgkqhkiG9w0BBwEwHgYJYIZIAWUDBAEuMBEEDCShnrlnnFNirDSCMAIBEIAlBmK3EXiMP28baPXNyyWTM3Y/C4mr2CbJNaN2GgWd/T1+1HCn8g=="
      },
      { "name": "DRONE_GITHUB_SECRET",
        "value": "AQECAHjxFVv28s35RRShRB2bYo11qtmAuBRaqhGRrhmkdMTRYgAAAGgwZgYJKoZIhvcNAQcGoFkwVwIBADBSBgkqhkiG9w0BBwEwHgYJYIZIAWUDBAEuMBEEDCShnrlnnFNirDSCMAIBEIAlBmK3EXiMP28baPXNyyWTM3Y/C4mr2CbJNaN2GgWd/T1+1HCn8g=="
      }
    ],
    "mountPoints": [
      { "sourceVolume": "droneci_data",
        "containerPath": "/var/lib/drone"
      }
    ],
    "command": [
        "awscli", "kms", "decrypt",
            "--ciphertext-blob", "$DRONE_SECRET",
            "--output", "text",
            "--query", "Plaintext",
            "|", "base64", "--decode", ">", "/data/drone-secrets.env",
        "awscli", "kms", "decrypt",
            "--ciphertext-blob", "$DRONE_GITHUB_SECRET",
            "--output", "text",
            "--query", "Plaintext",
            "|", "base64", "--decode", ">>", "/data/drone-secrets.env"
    ],
    "logConfiguration": {
      "logDriver": "awslogs",
      "options": {
        "awslogs-group": "${log_group_name}",
        "awslogs-region": "${log_group_region}"
      }
    }
  },
  { "cpu": 256,
    "essential": true,
    "image": "drone/drone:latest",
    "memoryReservation": 50,
    "name": "droneci-server",
    "environment": [
      { "name": "VIRTUAL_HOST", "value": "ci.lrvick.net" },
      { "name": "LETSENCRYPT_HOST", "value": "ci.lrvick.net" },
      { "name": "LETSENCRYPT_EMAIL", "value": "lance@lrvick.net" },
      { "name": "DRONE_OPEN", "value": "true" },
      { "name": "DRONE_GITHUB", "value": "true" },
      { "name": "DRONE_GITHUB_CLIENT", "value": "true" }
    ],
    "portMappings": [
      { "containerPort": 8000, "hostPort": 4443 }
    ],
    "volumesFrom": [
      { "sourceContainer": "kms-secrets" }
    ],
    "mountPoints": [
      { "sourceVolume":"droneci_data",
        "containerPath":"/var/lib/drone"
      }
    ],
    "logConfiguration": {
      "logDriver": "awslogs",
      "options": {
        "awslogs-group": "${log_group_name}",
        "awslogs-region": "${log_group_region}"
      }
    }
  },
  { "cpu": 256,
    "essential": true,
    "image": "drone/drone:latest",
    "memoryReservation": 50,
    "name": "droneci-agent",
    "environment": [
      { "name": "DRONE_SERVER", "value": "ws://droneci-server:8000/ws/broker" },
      { "name": "DRONE_SECRET", "value": "yep" }
    ],
    "mountPoints": [
      { "sourceVolume":"docker_sock",
        "containerPath":"/var/run/docker.sock"
      }
    ],
    "logConfiguration": {
      "logDriver": "awslogs",
      "options": {
        "awslogs-group": "${log_group_name}",
        "awslogs-region": "${log_group_region}"
      }
    }
  }
]
